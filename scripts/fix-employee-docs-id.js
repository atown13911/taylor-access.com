const { Client } = require('pg');
const TARGET_URL = 'postgresql://postgres:PdMRjqwZUlmsOwRQtxGiUVUdAjWGuxXw@maglev.proxy.rlwy.net:57249/railway';

async function run() {
  const tgt = new Client({ connectionString: TARGET_URL });
  await tgt.connect();

  // Check current max Id
  const { rows } = await tgt.query('SELECT MAX("Id") as max_id FROM "EmployeeDocuments"');
  const maxId = rows[0].max_id || 0;
  console.log('Current max Id:', maxId);

  // Create sequence if not exists and set it
  try {
    await tgt.query(`CREATE SEQUENCE IF NOT EXISTS "EmployeeDocuments_Id_seq" OWNED BY "EmployeeDocuments"."Id"`);
    await tgt.query(`SELECT setval('"EmployeeDocuments_Id_seq"', $1, true)`, [Math.max(maxId, 1)]);
    await tgt.query(`ALTER TABLE "EmployeeDocuments" ALTER COLUMN "Id" SET DEFAULT nextval('"EmployeeDocuments_Id_seq"')`);
    console.log('Fixed: Id column now auto-increments from', maxId + 1);
  } catch (e) {
    console.log('Error:', e.message);
    // Try alternative approach
    try {
      await tgt.query(`ALTER TABLE "EmployeeDocuments" ALTER COLUMN "Id" ADD GENERATED BY DEFAULT AS IDENTITY`);
      await tgt.query(`SELECT setval(pg_get_serial_sequence('"EmployeeDocuments"', 'Id'), $1, true)`, [maxId]);
      console.log('Fixed with IDENTITY');
    } catch (e2) {
      console.log('Alt error:', e2.message);
    }
  }

  // Also fix ExpiresAt column if missing
  try {
    await tgt.query(`ALTER TABLE "EmployeeDocuments" ADD COLUMN IF NOT EXISTS "ExpiresAt" DATE`);
    console.log('ExpiresAt column verified');
  } catch (e) {
    console.log('ExpiresAt note:', e.message);
  }

  await tgt.end();
}

run().catch(e => { console.error(e.message); process.exit(1); });
