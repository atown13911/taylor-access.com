<div class="driver-list-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <h1><i class='bx bx-id-card'></i> Drivers</h1>
      <p class="subtitle">
        @if (fleetName()) {
          Drivers assigned to <strong>{{ fleetName() }}</strong>
        } @else {
          All drivers in your organization
        }
      </p>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="loadDrivers()" title="Refresh">
        <i class='bx bx-refresh'></i>
      </button>
      <button class="btn btn-primary" (click)="openAddModal()">
        <i class='bx bx-plus'></i> Add Driver
      </button>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-icon total"><i class='bx bx-group'></i></div>
      <div class="stat-info">
        <span class="stat-value">{{ stats().total }}</span>
        <span class="stat-label">Total Drivers</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon active"><i class='bx bx-check-circle'></i></div>
      <div class="stat-info">
        <span class="stat-value">{{ stats().active }}</span>
        <span class="stat-label">Active</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon dispatched"><i class='bx bx-navigation'></i></div>
      <div class="stat-info">
        <span class="stat-value">{{ stats().dispatched }}</span>
        <span class="stat-label">Dispatched</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon off-duty"><i class='bx bx-moon'></i></div>
      <div class="stat-info">
        <span class="stat-value">{{ stats().offDuty }}</span>
        <span class="stat-label">Off Duty</span>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="driver-tabs">
    <button class="driver-tab" [class.active]="activeTab() === 'active'" (click)="activeTab.set('active')">
      <i class='bx bx-check-circle'></i> Active <span class="driver-tab-count">{{ tabCounts().active }}</span>
    </button>
    <button class="driver-tab" [class.active]="activeTab() === 'inactive'" (click)="activeTab.set('inactive')">
      <i class='bx bx-pause-circle'></i> Inactive <span class="driver-tab-count">{{ tabCounts().inactive }}</span>
    </button>
    <button class="driver-tab" [class.active]="activeTab() === 'archived'" (click)="activeTab.set('archived')">
      <i class='bx bx-archive'></i> Archived <span class="driver-tab-count">{{ tabCounts().archived }}</span>
    </button>
  </div>

  <!-- Search -->
  <div class="search-bar">
    <i class='bx bx-search'></i>
    <input type="text" placeholder="Search by name, phone, email, license..." [ngModel]="searchQuery()" (ngModelChange)="searchQuery.set($event)">
  </div>

  <!-- Loading -->
  @if (isLoading()) {
    <div class="loading-state">
      <i class='bx bx-loader-alt bx-spin'></i>
      <p>Loading drivers...</p>
    </div>
  } @else if (filteredDrivers().length === 0) {
    <div class="empty-state">
      <i class='bx bx-id-card'></i>
      <h3>No drivers found</h3>
      <p>No drivers match your current filters.</p>
    </div>
  } @else {
    <!-- Table -->
    <div class="data-table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>Email</th>
            <th>License #</th>
            <th>License Exp</th>
            <th>Type</th>
            <th>Fleet</th>
            <th>Hire Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (driver of filteredDrivers(); track driver.id) {
            <tr>
              <td class="name-cell">
                <div class="avatar">{{ driver.name.charAt(0) }}</div>
                {{ driver.name }}
              </td>
              <td>{{ driver.phone }}</td>
              <td>{{ driver.email || '—' }}</td>
              <td class="mono">{{ driver.licenseNumber || '—' }}</td>
              <td [class.expiring]="isExpiringSoon(driver.licenseExpiry)" [class.expired]="isExpired(driver.licenseExpiry)">
                {{ formatDate(driver.licenseExpiry) }}
              </td>
              <td><span class="type-badge" [class]="driver.type">{{ driver.type }}</span></td>
              <td>
                @if (driver.fleetName !== '—') {
                  <span class="fleet-badge">{{ driver.fleetName }}</span>
                } @else {
                  <span class="no-fleet">—</span>
                }
              </td>
              <td>{{ formatDate(driver.hireDate) }}</td>
              <td><span class="status-badge" [class]="driver.status">{{ driver.status }}</span></td>
              <td class="actions-cell">
                <button class="action-btn" title="View Profile" (click)="viewDriver(driver)"><i class='bx bx-user'></i></button>
                <button class="action-btn" title="Edit" (click)="editDriver(driver)"><i class='bx bx-edit'></i></button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>

<!-- Add/Edit Driver Modal -->
@if (showModal()) {
  <div class="modal-overlay" (click)="closeModal()">
    <div class="modal modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ modalType() === 'add' ? 'Add Driver' : 'Edit Driver' }}</h3>
        <button class="close-btn" (click)="closeModal()"><i class='bx bx-x'></i></button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <h4>Basic Information</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Full Name *</label>
              <input type="text" [ngModel]="driverForm().name" (ngModelChange)="updateField('name', $event)">
            </div>
            <div class="form-group">
              <label>Phone *</label>
              <input type="tel" [ngModel]="driverForm().phone" (ngModelChange)="updateField('phone', $event)" placeholder="(555) 123-4567">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Email</label>
              <input type="email" [ngModel]="driverForm().email" (ngModelChange)="updateField('email', $event)">
            </div>
            <div class="form-group">
              <label>Date of Birth</label>
              <input type="date" [ngModel]="driverForm().dateOfBirth" (ngModelChange)="updateField('dateOfBirth', $event)">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>License Information</h4>
          <div class="form-row">
            <div class="form-group">
              <label>CDL Number</label>
              <input type="text" [ngModel]="driverForm().licenseNumber" (ngModelChange)="updateField('licenseNumber', $event)">
            </div>
            <div class="form-group">
              <label>State</label>
              <input type="text" list="us-states" [ngModel]="driverForm().licenseState" (ngModelChange)="updateField('licenseState', $event.toUpperCase())" placeholder="Select state" maxlength="2" autocomplete="off">
            </div>
            <div class="form-group">
              <label>Expiry Date</label>
              <input type="date" [ngModel]="driverForm().licenseExpiry" (ngModelChange)="updateField('licenseExpiry', $event)">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Address</h4>
          <div class="form-group full-width">
            <label>Street Address</label>
            <input type="text" [ngModel]="driverForm().address" (ngModelChange)="updateField('address', $event)">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>City</label>
              <input type="text" [ngModel]="driverForm().city" (ngModelChange)="updateField('city', $event)">
            </div>
            <div class="form-group">
              <label>State</label>
              <input type="text" list="us-states" [ngModel]="driverForm().state" (ngModelChange)="updateField('state', $event.toUpperCase())" placeholder="Select state" maxlength="2" autocomplete="off">
            </div>
            <div class="form-group">
              <label>ZIP</label>
              <input type="text" [ngModel]="driverForm().zip" (ngModelChange)="updateField('zip', $event)">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Fleet & Division</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Assigned Fleet</label>
              <select [ngModel]="driverForm().fleetId" (ngModelChange)="updateField('fleetId', $event ? +$event : null)">
                <option [ngValue]="null">— No Fleet —</option>
                @for (fleet of availableFleets(); track fleet.id) {
                  <option [ngValue]="fleet.id">{{ fleet.name }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>Division</label>
              <select [ngModel]="driverForm().divisionId" (ngModelChange)="updateField('divisionId', $event ? +$event : null)" [disabled]="!driverForm().fleetId">
                <option [ngValue]="null">— No Division —</option>
                @for (div of availableDivisions(); track div.id) {
                  <option [ngValue]="div.id">{{ div.name }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>Terminal</label>
              <select [ngModel]="driverForm().driverTerminalId" (ngModelChange)="updateField('driverTerminalId', $event ? +$event : null)" [disabled]="!driverForm().divisionId">
                <option [ngValue]="null">— No Terminal —</option>
                @for (term of availableDriverTerminals(); track term.id) {
                  <option [ngValue]="term.id">{{ term.name }}</option>
                }
              </select>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4>Employment</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Driver Type</label>
              <select [ngModel]="driverForm().driverType" (ngModelChange)="updateField('driverType', $event)">
                <option value="company">Company</option>
                <option value="owner_operator">Owner Operator</option>
                <option value="lease">Lease</option>
                <option value="team">Team</option>
              </select>
            </div>
            <div class="form-group">
              <label>Hire Date</label>
              <input type="date" [ngModel]="driverForm().hireDate" (ngModelChange)="updateField('hireDate', $event)">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Pay Type</label>
              <select [ngModel]="driverForm().payType" (ngModelChange)="updateField('payType', $event)">
                <option value="mile">Per Mile</option>
                <option value="hour">Hourly</option>
                <option value="percentage">Percentage</option>
              </select>
            </div>
            <div class="form-group">
              <label>Pay Rate</label>
              <input type="number" [ngModel]="driverForm().payRate" (ngModelChange)="updateField('payRate', +$event)" step="0.01">
            </div>
          </div>
        </div>

        @if (driverForm().driverType === 'team') {
          <div class="form-section team-driver-section">
            <h4><i class='bx bx-group'></i> Team Driver Partner</h4>
            <div class="form-row">
              <div class="form-group">
                <label>Co-Driver</label>
                <select [ngModel]="driverForm().teamDriverId" (ngModelChange)="updateField('teamDriverId', $event ? +$event : null); updateField('teamDriverName', getDriverNameById(+$event))">
                  <option [ngValue]="null">-- Select co-driver --</option>
                  @for (d of drivers(); track d.id) {
                    @if (d.id !== editingId()) {
                      <option [ngValue]="d.id">{{ d.name }}</option>
                    }
                  }
                </select>
              </div>
              <div class="form-group">
                <label>Co-Driver Name</label>
                <input type="text" [ngModel]="driverForm().teamDriverName" (ngModelChange)="updateField('teamDriverName', $event)" placeholder="Auto-filled or enter manually">
              </div>
            </div>
          </div>
        }

        <div class="form-section">
          <h4>Emergency Contact</h4>
          <div class="form-row">
            <div class="form-group">
              <label>Contact Name</label>
              <input type="text" [ngModel]="driverForm().emergencyContact" (ngModelChange)="updateField('emergencyContact', $event)">
            </div>
            <div class="form-group">
              <label>Contact Phone</label>
              <input type="tel" [ngModel]="driverForm().emergencyPhone" (ngModelChange)="updateField('emergencyPhone', $event)" placeholder="(555) 987-6543">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeModal()">Cancel</button>
        <button class="btn btn-primary" (click)="saveDriver()" [disabled]="saving()">
          @if (saving()) {
            <i class='bx bx-loader-alt bx-spin'></i> Saving...
          } @else {
            <i class='bx bx-check'></i> Save
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Driver Details Panel -->
@if (selectedDriver()) {
  <div class="panel-overlay" (click)="closeProfile()"></div>
  <aside class="details-panel">
    <div class="panel-header">
      <h2>Driver Details</h2>
      <button class="close-btn" (click)="closeProfile()"><i class='bx bx-x'></i></button>
    </div>

    <div class="panel-avatar">
      <div class="big-avatar">{{ selectedDriver()!.name?.charAt(0) || '?' }}</div>
      <h3>{{ selectedDriver()!.name }}</h3>
      <span class="panel-status" [class]="'status-' + (selectedDriver()!.status || 'active')">{{ selectedDriver()!.status || 'active' }}</span>
    </div>

    <div class="panel-section">
      <h4>Contact</h4>
      <div class="detail-row"><span class="label">Phone</span><span>{{ selectedDriver()!.phone || '—' }}</span></div>
      <div class="detail-row"><span class="label">Email</span><span>{{ selectedDriver()!.email || '—' }}</span></div>
    </div>

    <div class="panel-section">
      <h4>License</h4>
      <div class="detail-row"><span class="label">Number</span><span class="mono">{{ selectedDriver()!.licenseNumber || '—' }}</span></div>
      <div class="detail-row"><span class="label">State</span><span>{{ selectedDriver()!.licenseState || '—' }}</span></div>
      <div class="detail-row">
        <span class="label">Expires</span>
        <span [class.expiring]="isExpiringSoon(selectedDriver()!.licenseExpiry)" [class.expired]="isExpired(selectedDriver()!.licenseExpiry)">
          {{ formatDate(selectedDriver()!.licenseExpiry) }}
        </span>
      </div>
      <div class="detail-row"><span class="label">Class</span><span>{{ selectedDriver()!.licenseClass || '—' }}</span></div>
    </div>

    <div class="panel-section">
      <h4>Employment</h4>
      <div class="detail-row"><span class="label">Type</span><span>{{ selectedDriver()!.type || '—' }}</span></div>
      <div class="detail-row"><span class="label">Hire Date</span><span>{{ formatDate(selectedDriver()!.hireDate) }}</span></div>
      <div class="detail-row"><span class="label">Fleet</span><span>{{ selectedDriver()!.fleetName || '—' }}</span></div>
    </div>

    <div class="panel-section">
      <h4>Compliance Summary</h4>
      @for (doc of complianceItems; track doc.key) {
        <div class="compliance-row">
          <span class="dot" [class]="getComplianceStatus(selectedDriver()!, doc.key)"></span>
          <span class="comp-label">{{ doc.label }}</span>
        </div>
      }
    </div>
  </aside>
}

<!-- US States datalist -->
<datalist id="us-states">
  @for (s of usStates; track s.code) {
    <option [value]="s.code">{{ s.name }}</option>
  }
</datalist>
