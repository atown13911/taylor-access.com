<div class="page-container">
  <header class="page-header">
    <div class="header-title">
      <h1><i class='bx bxs-user-account'></i> User Management</h1>
      <p class="subtitle">{{ users().length }} users in system</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-secondary" (click)="refreshData()">
        <i class='bx bx-refresh'></i> Refresh
      </button>
      <button class="btn btn-primary" (click)="showAddModal.set(true)" title="Add User">
        <i class='bx bx-plus'></i>
      </button>
    </div>
  </header>

  <!-- Filters -->
  <div class="filters-bar">
    @if (isProductOwner()) {
      <select [(ngModel)]="orgFilter" (ngModelChange)="applyFilters()">
        <option value="">All Organizations</option>
        @for (org of organizations(); track org.id) {
          <option [value]="org.id">{{ org.name }}</option>
        }
      </select>
    }
    <div class="search-box">
      <i class='bx bx-search'></i>
      <input 
        type="text" 
        placeholder="Search by name or email..." 
        [(ngModel)]="searchTerm"
        (ngModelChange)="applyFilters()"
      >
    </div>
    <select [(ngModel)]="statusFilter" (ngModelChange)="applyFilters()">
      <option value="">All Statuses</option>
      <option value="active">Active</option>
      <option value="inactive">Inactive</option>
      <option value="pending">Pending</option>
    </select>
    <select [(ngModel)]="roleFilter" (ngModelChange)="applyFilters()">
      <option value="">All Roles</option>
      @for (role of roles(); track role.id) {
        <option [value]="role.id">{{ role.name }}</option>
      }
    </select>
  </div>

  <!-- Tabs -->
  <div class="user-tabs">
    <button class="user-tab" [class.active]="activeTab() === 'live'" (click)="switchTab('live')">
      <i class='bx bx-check-circle'></i> Active <span class="tab-count">{{ liveUsers().length }}</span>
    </button>
    <button class="user-tab" [class.active]="activeTab() === 'inactive'" (click)="switchTab('inactive')">
      <i class='bx bx-user-x'></i> Inactive <span class="tab-count">{{ inactiveUsers().length }}</span>
    </button>
    <button class="user-tab" [class.active]="activeTab() === 'archived'" (click)="switchTab('archived')">
      <i class='bx bx-archive'></i> Archived <span class="tab-count">{{ archivedUsers().length }}</span>
    </button>
    <button class="user-tab" [class.active]="activeTab() === 'database'" (click)="switchTab('database')">
      <i class='bx bx-data'></i> Database <span class="tab-count">{{ users().length }}</span>
    </button>
    <button class="user-tab" [class.active]="activeTab() === 'logs'" (click)="switchTab('logs')">
      <i class='bx bx-history'></i> Logs <span class="tab-count">{{ auditLogs().length || '...' }}</span>
    </button>
  </div>

  @if (activeTab() === 'logs') {
    <!-- ==================== LOGS TAB ==================== -->
    <div class="logs-toolbar">
      <div class="search-input">
        <i class='bx bx-search'></i>
        <input type="text" placeholder="Search logs..." [ngModel]="logSearch()" (ngModelChange)="logSearch.set($event); logPage.set(1)">
      </div>
      <select class="log-filter-select" [ngModel]="logActionFilter()" (ngModelChange)="logActionFilter.set($event); logPage.set(1)">
        <option value="">All Actions</option>
        @for (a of uniqueLogActions(); track a) {
          <option [value]="a">{{ a }}</option>
        }
      </select>
      <select class="log-filter-select" [ngModel]="logUserFilter()" (ngModelChange)="logUserFilter.set($event); logPage.set(1)">
        <option value="">All Users</option>
        @for (u of uniqueLogUsers(); track u) {
          <option [value]="u">{{ u }}</option>
        }
      </select>
      @if (logSearch() || logActionFilter() || logUserFilter()) {
        <button class="clear-filters-btn" (click)="resetLogFilters()"><i class='bx bx-x'></i> Clear</button>
      }
      <span class="logs-count">{{ filteredAuditLogs().length }} entries</span>
    </div>

    @if (auditLoading()) {
      <div class="loading-state">
        <i class='bx bx-loader-alt bx-spin'></i>
        <p>Loading audit logs...</p>
      </div>
    } @else if (filteredAuditLogs().length === 0) {
      <div class="empty-state">
        <i class='bx bx-history'></i>
        <h3>No audit logs found</h3>
        <p>User activity will appear here</p>
      </div>
    } @else {
      <div class="table-container">
        <table class="users-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Action</th>
              <th>Entity</th>
              <th>Description</th>
              <th>IP Address</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            @for (log of paginatedLogs(); track log.id) {
              <tr class="log-row" (click)="log.userId ? loadUserActivity(log.userId, log.userName || 'Unknown') : null">
                <td>
                  <div class="user-cell">
                    <div class="avatar small">{{ (log.userName || '?').charAt(0).toUpperCase() }}</div>
                    <div>
                      <strong>{{ log.userName || 'System' }}</strong>
                      <span class="email-sub">{{ log.userEmail || '' }}</span>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="action-badge" [style.background]="getActionColor(log.action) + '1a'" [style.color]="getActionColor(log.action)" [style.border-color]="getActionColor(log.action) + '40'">
                    {{ log.action }}
                  </span>
                </td>
                <td>
                  <span class="entity-name">{{ log.entityType }}</span>
                  @if (log.entityName) {
                    <span class="entity-detail">{{ log.entityName }}</span>
                  }
                </td>
                <td class="desc-cell">{{ log.description || '-' }}</td>
                <td class="ip-cell">{{ log.ipAddress || '-' }}</td>
                <td class="date-cell">{{ formatLogDate(log.timestamp) }}</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }

    <!-- Pagination -->
    @if (totalLogPages() > 1) {
      <div class="log-pagination">
        <button class="page-btn" [disabled]="logPage() === 1" (click)="setLogPage(1)"><i class='bx bx-chevrons-left'></i></button>
        <button class="page-btn" [disabled]="logPage() === 1" (click)="setLogPage(logPage() - 1)"><i class='bx bx-chevron-left'></i></button>
        <span class="page-info">Page {{ logPage() }} of {{ totalLogPages() }}</span>
        <button class="page-btn" [disabled]="logPage() === totalLogPages()" (click)="setLogPage(logPage() + 1)"><i class='bx bx-chevron-right'></i></button>
        <button class="page-btn" [disabled]="logPage() === totalLogPages()" (click)="setLogPage(totalLogPages())"><i class='bx bx-chevrons-right'></i></button>
        <span class="page-showing">Showing {{ (logPage() - 1) * logsPerPage + 1 }}-{{ Math.min(logPage() * logsPerPage, filteredAuditLogs().length) }} of {{ filteredAuditLogs().length }}</span>
      </div>
    }

    <!-- User Activity Panel -->
    @if (selectedUserActivity()) {
      <div class="activity-panel">
        <div class="activity-header">
          <h3><i class='bx bx-user'></i> Activity for {{ selectedActivityUser() }}</h3>
          <button class="close-btn" (click)="closeActivityPanel()"><i class='bx bx-x'></i></button>
        </div>
        @if (activityLoading()) {
          <div class="loading-state small"><i class='bx bx-loader-alt bx-spin'></i> Loading...</div>
        } @else if (selectedUserActivity()!.length === 0) {
          <p class="empty-msg">No recent activity found</p>
        } @else {
          <div class="activity-list">
            @for (a of selectedUserActivity()!; track a.id) {
              <div class="activity-item">
                <span class="action-badge small" [style.background]="getActionColor(a.action) + '1a'" [style.color]="getActionColor(a.action)" [style.border-color]="getActionColor(a.action) + '40'">{{ a.action }}</span>
                <span class="activity-desc">{{ a.description || a.entityType + ' ' + a.action }}</span>
                <span class="activity-date">{{ formatLogDate(a.timestamp) }}</span>
              </div>
            }
          </div>
        }
      </div>
    }
  } @else {

  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <i class='bx bxs-group stat-icon total'></i>
      <div class="stat-info">
        <span class="stat-value">{{ users().length }}</span>
        <span class="stat-label">Total Users</span>
      </div>
    </div>
    <div class="stat-card">
      <i class='bx bxs-user-check stat-icon active'></i>
      <div class="stat-info">
        <span class="stat-value">{{ activeCount() }}</span>
        <span class="stat-label">Active</span>
      </div>
    </div>
    <div class="stat-card">
      <i class='bx bxs-user-x stat-icon inactive'></i>
      <div class="stat-info">
        <span class="stat-value">{{ inactiveCount() }}</span>
        <span class="stat-label">Inactive</span>
      </div>
    </div>
    <div class="stat-card">
      <i class='bx bx-time stat-icon pending'></i>
      <div class="stat-info">
        <span class="stat-value">{{ pendingCount() }}</span>
        <span class="stat-label">Pending</span>
      </div>
    </div>
    <div class="stat-card">
      <i class='bx bx-shield stat-icon'></i>
      <div class="stat-info">
        <span class="stat-value">{{ twoFactorCount() }}</span>
        <span class="stat-label">2FA Enabled</span>
      </div>
    </div>
  </div>

  @if (loading()) {
    <div class="loading-state">
      <i class='bx bx-loader-alt bx-spin'></i>
      <p>Loading users...</p>
    </div>
  } @else if (filteredUsers().length === 0) {
    <div class="empty-state">
      <i class='bx bxs-user'></i>
      <h3>No users found</h3>
      <p>Add users to your organization</p>
    </div>
  } @else {
    <!-- Users Table -->
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Role</th>
            <th>Organization</th>
            <th>Status</th>
            <th>2FA</th>
            <th>Last Login</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (user of filteredUsers(); track user.id) {
            <tr>
              <td>
                <div class="user-cell">
                  <div class="user-avatar-wrap">
                    <div class="user-avatar">
                      {{ getInitials(user.name) }}
                    </div>
                    <span class="online-dot" [class.online]="isOnline(user)" [class.recent]="isRecent(user)" [title]="isOnline(user) ? 'Online now' : isRecent(user) ? 'Active recently' : 'Offline'"></span>
                  </div>
                  <div class="user-info">
                    <span class="user-name">{{ user.name }}</span>
                    <span class="user-email">{{ user.email }}</span>
                  </div>
                </div>
              </td>
              <td>
                <span class="role-badge">{{ user.role || 'No Role' }}</span>
              </td>
              <td>{{ user.organizationName || 'N/A' }}</td>
              <td>
                <span class="status-badge" [ngClass]="user.status">{{ user.status }}</span>
              </td>
              <td>
                @if (user.twoFactorEnabled) {
                  <i class='bx bxs-shield-alt-2 two-fa-enabled'></i>
                } @else {
                  <i class='bx bx-shield two-fa-disabled'></i>
                }
              </td>
              <td>{{ user.lastLoginAt ? (user.lastLoginAt | date:'short') : 'Never' }}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn-icon" title="Edit" (click)="editUser(user)">
                    <i class='bx bx-edit'></i>
                  </button>
                  <button class="btn-icon" title="Set Password" (click)="openSetPasswordModal(user)">
                    <i class='bx bx-lock-open'></i>
                  </button>
                  <button class="btn-icon" title="Email Reset Link" (click)="resetPassword(user)">
                    <i class='bx bx-key'></i>
                  </button>
                  @if (user.role !== 'product_owner' && user.email !== 'austin.taylor@vantac.local') {
                    @if (user.status === 'active') {
                      <button class="btn-icon warning" title="Deactivate" (click)="toggleStatus(user)">
                        <i class='bx bx-block'></i>
                      </button>
                    } @else {
                      <button class="btn-icon success" title="Activate" (click)="toggleStatus(user)">
                        <i class='bx bx-check'></i>
                      </button>
                    }
                    @if (activeTab() === 'live') {
                      <button class="btn-icon warning" title="Archive" (click)="archiveUser(user)">
                        <i class='bx bx-archive-in'></i>
                      </button>
                    } @else if (activeTab() === 'inactive') {
                      <button class="btn-icon success" title="Activate" (click)="restoreUser(user)">
                        <i class='bx bx-check-circle'></i>
                      </button>
                      <button class="btn-icon warning" title="Archive" (click)="archiveUser(user)">
                        <i class='bx bx-archive-in'></i>
                      </button>
                    } @else {
                      <button class="btn-icon success" title="Restore" (click)="restoreUser(user)">
                        <i class='bx bx-revision'></i>
                      </button>
                    }
                    @if (isProductOwner()) {
                      <button class="btn-icon danger" title="Delete" (click)="deleteUser(user)">
                        <i class='bx bx-trash'></i>
                      </button>
                    }
                  } @else {
                    <span class="protected-badge" title="Product Owner account is protected">
                      <i class='bx bxs-shield-alt-2'></i> Protected
                    </span>
                  }
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
  } <!-- end of @else (non-logs content) -->

  <!-- Add/Edit Modal -->
  @if (showAddModal()) {
    <div class="modal-overlay">
      <div class="modal-content" >
        <div class="modal-header">
          <h2>{{ editingUser() ? 'Edit User' : 'Add New User' }}</h2>
          <button class="btn-close" (click)="closeModal()"><i class='bx bx-x'></i></button>
        </div>
        
        <form (ngSubmit)="saveUser()" class="user-form">
          <div class="form-grid">
            <div class="input-group">
              <label>Full Name *</label>
              <input type="text" [(ngModel)]="formData.name" name="name" required placeholder="John Doe" autocomplete="off">
            </div>
            <div class="input-group">
              <label>Work Email *</label>
              <input type="email" [(ngModel)]="formData.email" name="email" required placeholder="employee@company.com" autocomplete="off">
            </div>
            <div class="input-group">
              <label>Personal Email</label>
              <input type="email" [(ngModel)]="formData.personalEmail" name="personalEmail" autocomplete="off" placeholder="personal@example.com">
            </div>
            <div class="input-group full-width">
              <label>Phone Numbers</label>
              <div class="phone-entries">
                @for (entry of phoneEntries; track entry.id; let i = $index) {
                  <div class="phone-entry">
                    <select [(ngModel)]="entry.type" [ngModelOptions]="{standalone: true}" class="phone-type">
                      <option value="cell">Cell</option>
                      <option value="work">Work</option>
                      <option value="home">Home</option>
                      <option value="fax">Fax</option>
                      <option value="other">Other</option>
                    </select>
                    <select [(ngModel)]="entry.countryCode" [ngModelOptions]="{standalone: true}" class="phone-country">
                      @for (cc of countryCodes; track cc.code) {
                        <option [value]="cc.code">{{ cc.label }}</option>
                      }
                    </select>
                    <input
                      type="tel"
                      [(ngModel)]="entry.number"
                      [ngModelOptions]="{standalone: true}"
                      placeholder="555-123-4567"
                      class="phone-number"
                      autocomplete="new-phone">
                    @if (phoneEntries.length > 1) {
                      <button type="button" class="phone-remove" (click)="removePhoneEntry(i)" title="Remove">
                        <i class="bx bx-x"></i>
                      </button>
                    }
                  </div>
                }
                <button type="button" class="phone-add-btn" (click)="addPhoneEntry()">
                  <i class="bx bx-plus"></i> Add Phone Number
                </button>
              </div>
            </div>
            <div class="input-group">
              <label>Role</label>
              <select [(ngModel)]="formData.roleId" name="roleId">
                <option value="">Select Role</option>
                @for (role of roles(); track role.id) {
                  <option [value]="role.id">{{ role.name }}</option>
                }
              </select>
            </div>
            <div class="input-group full-width">
              <label>
                Organization Access
                <span class="info-text">(Select which organizations this user can access)</span>
              </label>
              
              <div class="access-mode-toggle">
                <button 
                  type="button"
                  class="mode-btn" 
                  [class.active]="orgAccessMode() === 'single'"
                  (click)="setOrgAccessMode('single')">
                  <i class="bx bx-building"></i> Single Organization
                </button>
                <button 
                  type="button"
                  class="mode-btn" 
                  [class.active]="orgAccessMode() === 'multiple'"
                  (click)="setOrgAccessMode('multiple')">
                  <i class="bx bx-buildings"></i> Multiple Organizations
                </button>
              </div>

              @if (orgAccessMode() === 'single') {
                <!-- Single Organization - Simple Dropdown -->
                <select 
                  [(ngModel)]="formData.organizationId" 
                  name="organizationId" 
                  class="org-select"
                  (ngModelChange)="onOrganizationChange($event)">
                  <option value="">Select Organization</option>
                  @for (org of organizations(); track org.id) {
                    <option [value]="org.id">{{ org.name }}</option>
                  }
                </select>
              } @else {
                <!-- Multiple Organizations - Table with Checkboxes -->
                <div class="org-table-container">
                  <table class="org-access-table">
                    <thead>
                      <tr>
                        <th width="50">
                          <input 
                            type="checkbox" 
                            (change)="toggleAllOrganizations($event)"
                            [checked]="allOrgsSelected()"
                            title="Select All">
                        </th>
                        <th>Organization</th>
                        <th>Country</th>
                        <th>Primary</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (org of organizations(); track org.id) {
                        <tr [class.selected]="isOrgSelected(org.id)">
                          <td>
                            <input 
                              type="checkbox" 
                              [checked]="isOrgSelected(org.id)"
                              (change)="toggleOrganization(org.id, $event)">
                          </td>
                          <td>
                            <i class="bx bxs-building"></i>
                            {{ org.name }}
                          </td>
                          <td>
                            <span class="country-badge">{{ org.country || 'USA' }}</span>
                          </td>
                          <td>
                            @if (formData.organizationId === org.id) {
                              <span class="primary-badge">Primary</span>
                            } @else if (isOrgSelected(org.id)) {
                              <button 
                                type="button"
                                class="set-primary-btn" 
                                (click)="setPrimaryOrganization(org.id)">
                                Set as Primary
                              </button>
                            }
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                  
                  <div class="org-summary">
                    <i class="bx bx-info-circle"></i>
                    <span>{{ selectedOrgCount() }} organization(s) selected</span>
                  </div>
                </div>
              }
            </div>
            <div class="input-group">
              <label>Department</label>
              <select [(ngModel)]="formData.departmentId" name="departmentId">
                <option [ngValue]="null">No Department</option>
                @for (dept of filteredModalDepartments(); track dept.id) {
                  <option [ngValue]="dept.id">{{ dept.name }}</option>
                }
              </select>
            </div>
            
            <div class="input-group">
              <label>Satellite</label>
              <button type="button" class="entity-select-btn" (click)="showSatelliteModal.set(true)">
                <i class='bx bx-building'></i>
                <span>{{ getSelectedSatelliteName() }}</span>
                <i class='bx bx-chevron-right'></i>
              </button>
            </div>
            
            <div class="input-group">
              <label>Agency</label>
              <button type="button" class="entity-select-btn" (click)="showAgencyModal.set(true)">
                <i class='bx bx-store-alt'></i>
                <span>{{ getSelectedAgencyName() }}</span>
                <i class='bx bx-chevron-right'></i>
              </button>
            </div>
            
            <div class="input-group">
              <label>Terminal</label>
              <button type="button" class="entity-select-btn" (click)="showTerminalModal.set(true)">
                <i class='bx bx-package'></i>
                <span>{{ getSelectedTerminalName() }}</span>
                <i class='bx bx-chevron-right'></i>
              </button>
            </div>
            <div class="input-group">
              <label>Position</label>
              <input type="text" [(ngModel)]="formData.jobTitle" name="jobTitle" placeholder="Senior Dispatcher">
            </div>
            <div class="input-group">
              <label>Zoom Account Email</label>
              <input type="email" [(ngModel)]="formData.zoomEmail" name="zoomEmail" placeholder="user@company.com">
            </div>
            @if (!editingUser()) {
              <div class="input-group full-width">
                <label>Password *</label>
                <input type="password" [(ngModel)]="formData.password" name="password" required minlength="8">
                <small>Minimum 8 characters</small>
              </div>
            }
            <div class="input-group">
              <label>Status</label>
              <select [(ngModel)]="formData.status" name="status">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="pending">Pending</option>
              </select>
            </div>
          </div>

          @if (formError()) {
            <div class="form-error">{{ formError() }}</div>
          }

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="saving()">
              @if (saving()) {
                <i class='bx bx-loader-alt bx-spin'></i> Saving...
              } @else {
                <i class='bx bx-check'></i> {{ editingUser() ? 'Update' : 'Create' }}
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Set Password Modal -->
  @if (showPasswordModal()) {
    <div class="modal-overlay">
      <div class="modal-content password-modal">
        <div class="modal-header">
          <h2><i class='bx bx-lock-open'></i> Set Password</h2>
          <button class="btn-close" (click)="closePasswordModal()"><i class='bx bx-x'></i></button>
        </div>
        
        <div class="modal-body">
          @if (passwordResetUser()) {
            <p>Set new password for <strong>{{ passwordResetUser()!.name }}</strong></p>
          }
          
          <div class="input-group">
            <label>New Password *</label>
            <input 
              type="password" 
              [(ngModel)]="newPassword" 
              placeholder="Minimum 8 characters"
              minlength="8">
          </div>
          
          @if (passwordError()) {
            <div class="error-message">{{ passwordError() }}</div>
          }
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closePasswordModal()">Cancel</button>
          <button type="button" class="btn btn-primary" (click)="setPassword()">
            <i class='bx bx-check'></i> Set Password
          </button>
        </div>
      </div>
    </div>
  }
  
  <!-- Satellite Selection Modal -->
  @if (showSatelliteModal()) {
    <div class="modal-overlay" (click)="showSatelliteModal.set(false)">
      <div class="modal-content entity-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2><i class='bx bx-building'></i> Select Satellite</h2>
          <button class="btn-close" (click)="showSatelliteModal.set(false)"><i class='bx bx-x'></i></button>
        </div>
        <div class="modal-body">
          <div class="entity-option" (click)="selectSatellite(null)">
            <input type="radio" [checked]="formData.satelliteId === null">
            <div class="option-info">
              <h4>Corporate (No Satellite)</h4>
              <p>User operates at corporate level</p>
            </div>
          </div>
          @for (satellite of satellites(); track satellite.id) {
            <div class="entity-option" (click)="selectSatellite(satellite.id)">
              <input type="radio" [checked]="formData.satelliteId === satellite.id">
              <div class="option-info">
                <h4>{{ satellite.name }}</h4>
                <p>{{ satellite.city }}, {{ satellite.state }}</p>
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  }
  
  <!-- Agency Selection Modal -->
  @if (showAgencyModal()) {
    <div class="modal-overlay" (click)="showAgencyModal.set(false)">
      <div class="modal-content entity-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2><i class='bx bx-store-alt'></i> Select Agency</h2>
          <button class="btn-close" (click)="showAgencyModal.set(false)"><i class='bx bx-x'></i></button>
        </div>
        <div class="modal-body">
          <table class="entity-table">
            <thead>
              <tr>
                <th width="50"></th>
                <th>Agency Name</th>
                <th>Division</th>
                <th>Location</th>
              </tr>
            </thead>
            <tbody>
              <tr (click)="selectAgency(null)" [class.selected]="formData.agencyId === null">
                <td><input type="checkbox" [checked]="formData.agencyId === null"></td>
                <td><strong>No Agency</strong></td>
                <td colspan="2">User not assigned to any agency</td>
              </tr>
              @for (agency of agencies(); track agency.id) {
                <tr (click)="selectAgency(agency.id)" [class.selected]="formData.agencyId === agency.id">
                  <td><input type="checkbox" [checked]="formData.agencyId === agency.id"></td>
                  <td><strong>{{ agency.name }}</strong></td>
                  <td>{{ agency.division || '-' }}</td>
                  <td>{{ agency.city }}, {{ agency.state }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  }
  
  <!-- Terminal Selection Modal -->
  @if (showTerminalModal()) {
    <div class="modal-overlay" (click)="showTerminalModal.set(false)">
      <div class="modal-content entity-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2><i class='bx bx-package'></i> Select Terminal</h2>
          <button class="btn-close" (click)="showTerminalModal.set(false)"><i class='bx bx-x'></i></button>
        </div>
        <div class="modal-body">
          <div class="entity-option" (click)="selectTerminal(null)">
            <input type="radio" [checked]="formData.terminalId === null">
            <div class="option-info">
              <h4>No Terminal</h4>
              <p>User not assigned to any terminal</p>
            </div>
          </div>
          @for (terminal of terminals(); track terminal.id) {
            <div class="entity-option" (click)="selectTerminal(terminal.id)">
              <input type="radio" [checked]="formData.terminalId === terminal.id">
              <div class="option-info">
                <h4>{{ terminal.name }}</h4>
                <p>{{ terminal.type }} - {{ terminal.city }}, {{ terminal.state }}</p>
              </div>
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>
